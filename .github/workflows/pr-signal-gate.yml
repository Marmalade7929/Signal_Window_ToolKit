name: PR Signal Gate

on:
  pull_request:
    branches: ["main", "dev"]

jobs:
  signal-gate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Validate PR narrative and commit messages
        uses: actions/github-script@v7
        with:
          script: |
            const requiredSections = [
              "## Summary",
              "## Problem and User Value",
              "## Evidence (Signal Pack)",
              "## Commit Quality",
              "## Risk and Rollback",
              "## Documentation and Release Notes",
              "## Governance Gate",
            ];
            const pr = context.payload.pull_request;
            const body = pr.body || "";

            const missing = requiredSections.filter((section) => !body.includes(section));
            if (missing.length > 0) {
              core.setFailed(
                `Missing required PR template sections: ${missing.join(", ")}`
              );
              return;
            }

            const commitPattern = /^(feat|fix|perf|refactor|test|docs|chore)(\([a-z0-9._/-]+\))?: .+/;
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 250,
            });

            const invalid = [];
            for (const commit of commits) {
              const headline = (commit.commit.message || "").split("\n")[0].trim();
              if (!commitPattern.test(headline)) {
                invalid.push(headline);
              }
            }

            if (invalid.length > 0) {
              core.setFailed(
                "Commit message format violations (expected <type>(<scope>): <summary>):\n" +
                invalid.map((m) => `- ${m}`).join("\n")
              );
            }

